<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>MR Studio Mobile - Fixed Gizmos</title>
  <style>
    body { margin: 0; background: #111; overflow: hidden; font-family: sans-serif; -webkit-user-select: none; user-select: none; touch-action: none; }
    
    #overlay {
      position: absolute; inset: 0; display: flex; flex-direction: column;
      justify-content: center; align-items: center; background: rgba(0,0,0,0.95); z-index: 999;
      transition: opacity 0.4s;
    }
    
    button.start-btn {
      padding: 15px 40px; font-size: 20px; background: #2b7fdb; border: none;
      border-radius: 50px; color: white; font-weight: bold;
      box-shadow: 0 0 20px rgba(43,127,219,0.4);
    }

    /* UI INFERIOR FLOTANTE */
    #toolbar {
      position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 8px; background: rgba(30, 30, 30, 0.9);
      padding: 10px 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
      backdrop-filter: blur(10px); z-index: 100;
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
    }

    .tool-btn {
      width: 50px; height: 50px; border-radius: 12px; border: none;
      background: #444; color: #ddd; font-size: 22px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: 0.2s;
    }
    .tool-btn:active { transform: scale(0.9); }
    .tool-btn.active { background: #2b7fdb; color: white; border: 1px solid white; }
    .label { font-size: 8px; margin-top: 2px; text-transform: uppercase; }

    #info {
      position: absolute; top: 20px; width: 100%; text-align: center; pointer-events: none;
      color: #888; font-size: 12px; text-shadow: 0 1px 2px black;
    }
    #sel-target { color: #2b7fdb; font-weight: bold; }
  </style>
</head>
<body>

<div id="overlay">
  <h1 style="color:#2b7fdb; font-size:40px; margin:0;">MR STUDIO</h1>
  <p style="color:#666; margin-bottom:40px;">Modo T√°ctil Corregido</p>
  <button class="start-btn" id="btn-start">EMPEZAR</button>
</div>

<div id="info">Seleccionado: <span id="sel-target">Nada</span></div>

<div id="toolbar">
  <button class="tool-btn" onclick="spawn('box')">üì¶<span class="label">Cubo</span></button>
  <button class="tool-btn" onclick="spawn('sphere')">‚ö™<span class="label">Esfera</span></button>
  <div style="width:1px; background:#666; margin:0 5px;"></div>
  <button class="tool-btn active" id="btn-move" onclick="setMode('translate')">‚ÜîÔ∏è<span class="label">Mover</span></button>
  <button class="tool-btn" id="btn-rot" onclick="setMode('rotate')">üîÑ<span class="label">Rotar</span></button>
  <button class="tool-btn" id="btn-scale" onclick="setMode('scale')">üìè<span class="label">Escala</span></button>
  <div style="width:1px; background:#666; margin:0 5px;"></div>
  <button class="tool-btn" style="background:#a33" onclick="del()">üóëÔ∏è<span class="label">Borrar</span></button>
</div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { TransformControls } from 'three/addons/controls/TransformControls.js';

let scene, camera, renderer, orbit, control;
const objects = [];
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

// Variables para detectar "TAP" vs "DRAG"
let touchStartTime = 0;
let touchStartX = 0;
let touchStartY = 0;

init();
animate();

function init() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x111111);
  scene.fog = new THREE.Fog(0x111111, 8, 30);

  // C√°mara centrada y un poco elevada
  camera = new THREE.PerspectiveCamera(55, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(3, 2.5, 4);

  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.shadowMap.enabled = true;
  document.body.appendChild(renderer.domElement);

  // Luces
  const amb = new THREE.AmbientLight(0x404040, 1.5);
  scene.add(amb);
  const dir = new THREE.DirectionalLight(0xffffff, 2);
  dir.position.set(5, 10, 5);
  dir.castShadow = true;
  scene.add(dir);
  
  const grid = new THREE.GridHelper(20, 40, 0x333333, 0x1a1a1a);
  scene.add(grid);

  // Controles de C√°mara (Orbit)
  orbit = new OrbitControls(camera, renderer.domElement);
  orbit.enableDamping = true;
  orbit.dampingFactor = 0.1;
  
  // === TRANSFORM CONTROLS (GIZMO) ===
  control = new TransformControls(camera, renderer.domElement);
  control.setSize(1.5); // Tama√±o grande para dedos
  control.space = 'local'; // Ejes alineados al objeto
  
  // IMPORTANTE: Al interactuar con el Gizmo, desactivamos la c√°mara
  control.addEventListener('dragging-changed', function (event) {
    orbit.enabled = !event.value;
  });
  
  scene.add(control);

  // === L√ìGICA DE TOQUE MEJORADA (Tap vs Drag) ===
  // Usamos pointerdown/up para distinguir si el usuario solo toc√≥ (seleccionar)
  // o si movi√≥ el dedo (rotar c√°mara o mover gizmo)
  
  renderer.domElement.addEventListener('pointerdown', (e) => {
    touchStartTime = Date.now();
    touchStartX = e.clientX;
    touchStartY = e.clientY;
  });

  renderer.domElement.addEventListener('pointerup', (e) => {
    const touchTime = Date.now() - touchStartTime;
    const moveX = Math.abs(e.clientX - touchStartX);
    const moveY = Math.abs(e.clientY - touchStartY);

    // Si el dedo se movi√≥ menos de 5px y fue r√°pido (<300ms), es un CLICK/TAP
    // Y IMPORTANTE: Solo seleccionamos si NO estamos arrastrando el Gizmo
    if (moveX < 5 && moveY < 5 && touchTime < 300 && !control.dragging) {
      checkSelection(e.clientX, e.clientY);
    }
  });

  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  document.getElementById('btn-start').addEventListener('click', () => {
    document.getElementById('overlay').style.opacity = 0;
    setTimeout(() => document.getElementById('overlay').style.display = 'none', 400);
    spawn('box');
  });

  // Exponer global
  window.spawn = spawn;
  window.setMode = setMode;
  window.del = del;
}

function checkSelection(x, y) {
  const rect = renderer.domElement.getBoundingClientRect();
  mouse.x = ((x - rect.left) / rect.width) * 2 - 1;
  mouse.y = -((y - rect.top) / rect.height) * 2 + 1;

  raycaster.setFromCamera(mouse, camera);
  const intersects = raycaster.intersectObjects(objects, false);

  if (intersects.length > 0) {
    const obj = intersects[0].object;
    if (control.object !== obj) {
      attachGizmo(obj);
    }
  } else {
    // Si toca el fondo vac√≠o, deselecciona
    detachGizmo();
  }
}

function attachGizmo(obj) {
  control.attach(obj);
  
  // Feedback visual
  objects.forEach(o => o.material.emissive.setHex(0x000000));
  obj.material.emissive.setHex(0x333333);
  
  document.getElementById('sel-target').innerText = "Objeto Activo";
}

function detachGizmo() {
  control.detach();
  objects.forEach(o => o.material.emissive.setHex(0x000000));
  document.getElementById('sel-target').innerText = "Nada";
}

function spawn(type) {
  let geo;
  if(type==='box') geo = new THREE.BoxGeometry(1,1,1);
  else geo = new THREE.SphereGeometry(0.6, 32, 32);

  const mat = new THREE.MeshStandardMaterial({
    color: Math.random() * 0xffffff,
    roughness: 0.2, metalness: 0.3
  });

  const mesh = new THREE.Mesh(geo, mat);
  mesh.castShadow = true; mesh.receiveShadow = true;
  mesh.position.set((Math.random()-0.5)*3, 0.5, (Math.random()-0.5)*3);
  
  scene.add(mesh);
  objects.push(mesh);
  attachGizmo(mesh);
}

function setMode(mode) {
  control.setMode(mode);
  document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
  if(mode === 'translate') document.getElementById('btn-move').classList.add('active');
  if(mode === 'rotate') document.getElementById('btn-rot').classList.add('active');
  if(mode === 'scale') document.getElementById('btn-scale').classList.add('active');
}

function del() {
  if (control.object) {
    const o = control.object;
    control.detach();
    scene.remove(o);
    objects.splice(objects.indexOf(o), 1);
    document.getElementById('sel-target').innerText = "Nada";
  }
}

function animate() {
  requestAnimationFrame(animate);
  orbit.update();
  renderer.render(scene, camera);
}
</script>
</body>
</html>

