<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>MR Studio Mobile - Gizmo Edition</title>
  <style>
    body { margin: 0; background: #1a1a1a; overflow: hidden; font-family: 'Segoe UI', sans-serif; -webkit-user-select: none; user-select: none; touch-action: none; }
    
    /* PANTALLA DE INICIO */
    #overlay {
      position: absolute; inset: 0; display: flex; flex-direction: column;
      justify-content: center; align-items: center; background: rgba(0,0,0,0.95); z-index: 999;
      transition: opacity 0.5s;
    }
    
    button.start-btn {
      padding: 20px 50px; font-size: 22px; background: #2b7fdb; border: none;
      border-radius: 30px; font-weight: 700; cursor: pointer; color: white;
      box-shadow: 0 6px 20px rgba(43,127,219,0.5);
    }
    button.start-btn:active { transform: scale(0.95); }

    /* BARRA DE HERRAMIENTAS INFERIOR (Estilo App Nativa) */
    #toolbar {
      position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 12px; background: rgba(30, 30, 30, 0.95);
      padding: 12px 25px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.15);
      backdrop-filter: blur(15px); z-index: 100; max-width: 95%; overflow-x: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .tool-btn {
      width: 55px; height: 55px; border-radius: 14px; border: none;
      background: #444; color: #ddd; font-size: 24px; cursor: pointer;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); flex-shrink: 0;
    }
    .tool-btn:active { transform: scale(0.85); }
    .tool-btn.active { background: #2b7fdb; color: white; box-shadow: 0 0 15px rgba(43,127,219,0.6); }
    .tool-label { font-size: 9px; margin-top: 3px; font-weight: 600; text-transform: uppercase; }

    /* INFO PANEL SUPERIOR */
    #info-panel {
      position: absolute; top: 15px; left: 15px; pointer-events: none;
      color: rgba(255,255,255,0.8); font-size: 13px; font-family: monospace;
      background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 8px;
    }
    
    .delete-btn { background: #a32a2a !important; }
    .create-group { background: #2a5fa3 !important; }
  </style>
</head>
<body>

<div id="overlay">
  <h1 style="color:#2b7fdb; margin:0; font-size: 3em;">MR STUDIO</h1>
  <p style="color:#aaa; margin-bottom:40px; font-size: 1.2em;">Edici√≥n T√°ctil con Gizmos</p>
  <button class="start-btn" id="btn-start">INICIAR APP</button>
</div>

<div id="info-panel">
  <div style="margin-bottom:4px;">Selecci√≥n: <span id="sel-name" style="color:#2b7fdb; font-weight:bold;">Ninguna</span></div>
  <div>Modo: <span id="mode-name" style="color:#aaa;">Navegaci√≥n</span></div>
</div>

<div id="toolbar">
  <button class="tool-btn create-group" onclick="spawnObject('box')">
    üì¶<span class="tool-label">Cubo</span>
  </button>
  <button class="tool-btn create-group" onclick="spawnObject('sphere')">
    ‚ö™<span class="tool-label">Esfera</span>
  </button>
  
  <div style="width:2px; background:#555; margin:0 8px; border-radius: 2px;"></div>

  <button class="tool-btn active" id="btn-trans" onclick="setTransformMode('translate')">
    ‚ÜîÔ∏è<span class="tool-label">Mover</span>
  </button>
  <button class="tool-btn" id="btn-rot" onclick="setTransformMode('rotate')">
    üîÑ<span class="tool-label">Rotar</span>
  </button>
  <button class="tool-btn" id="btn-scale" onclick="setTransformMode('scale')">
    üìè<span class="tool-label">Escala</span>
  </button>

  <div style="width:2px; background:#555; margin:0 8px; border-radius: 2px;"></div>

  <button class="tool-btn delete-btn" onclick="deleteSelected()">
    üóëÔ∏è<span class="tool-label">Borrar</span>
  </button>
</div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { TransformControls } from 'three/addons/controls/TransformControls.js';

// ================= VARIABLES GLOBALES =================
let scene, camera, renderer;
let orbit, transformControl;
const objects = [];
let raycaster, mouse;
let isInteractingWithGizmo = false;

init();
animate();

function init() {
  // 1. ESCENA
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x1a1a1a);
  scene.fog = new THREE.Fog(0x1a1a1a, 8, 40);

  // 2. C√ÅMARA (Posici√≥n inicial elevada para ver mejor el grid)
  camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(4, 4, 6);

  // 3. RENDERER (Optimizado para m√≥viles)
  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // L√≠mite de pixel ratio para rendimiento
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  document.body.appendChild(renderer.domElement);

  // 4. LUCES
  setupLights();

  // 5. GRID & HELPERS
  const gridHelper = new THREE.GridHelper(30, 60, 0x444444, 0x222222);
  scene.add(gridHelper);
  const axesHelper = new THREE.AxesHelper(2);
  scene.add(axesHelper);

  // 6. CONTROLES DE C√ÅMARA (ORBIT) - Navegaci√≥n con dedos
  orbit = new OrbitControls(camera, renderer.domElement);
  orbit.enableDamping = true;
  orbit.dampingFactor = 0.08;
  orbit.screenSpacePanning = false;
  orbit.maxPolarAngle = Math.PI / 2.1; // No dejar que la c√°mara baje del suelo

  // 7. CONTROLES DE TRANSFORMACI√ìN (EL GIZMO T√ÅCTIL)
  transformControl = new TransformControls(camera, renderer.domElement);
  
  // === CLAVE PARA M√ìVIL: GIZMO GIGANTE ===
  // Aumentamos el tama√±o del gizmo para que sea f√°cil de tocar con el dedo.
  transformControl.setSize(1.8); 
  
  // Eventos para evitar que la c√°mara se mueva mientras usamos el gizmo
  transformControl.addEventListener('dragging-changed', function (event) {
    isInteractingWithGizmo = event.value;
    orbit.enabled = !isInteractingWithGizmo; // Desactiva la √≥rbita si arrastramos el gizmo
  });
  
  scene.add(transformControl);

  // 8. RAYCASTER (Para seleccionar objetos al tocar)
  raycaster = new THREE.Raycaster();
  mouse = new THREE.Vector2();

  // ================= EVENTOS DEL SISTEMA =================
  window.addEventListener('resize', onWindowResize);
  
  // Usamos pointerdown para detectar el toque inicial
  renderer.domElement.addEventListener('pointerdown', onPointerDown);

  // Bot√≥n de inicio
  document.getElementById('btn-start').addEventListener('click', () => {
    const overlay = document.getElementById('overlay');
    overlay.style.opacity = 0;
    setTimeout(() => overlay.style.display = 'none', 500);
    // Crear un objeto inicial
    window.spawnObject('box');
  });

  // Exponer funciones al √°mbito global para que los botones HTML funcionen
  window.spawnObject = spawnObject;
  window.setTransformMode = setTransformMode;
  window.deleteSelected = deleteSelected;

  setTransformMode('translate'); // Modo inicial
}

function setupLights() {
  const ambient = new THREE.AmbientLight(0x404040, 1); // Luz ambiental suave
  scene.add(ambient);

  const dirLight = new THREE.DirectionalLight(0xffffff, 1.8);
  dirLight.position.set(5, 12, 8);
  dirLight.castShadow = true;
  // Sombras m√°s n√≠tidas
  dirLight.shadow.mapSize.width = 2048;
  dirLight.shadow.mapSize.height = 2048;
  dirLight.shadow.camera.near = 0.5;
  dirLight.shadow.camera.far = 50;
  dirLight.shadow.bias = -0.0005;
  
  // √Årea de sombra
  const d = 10;
  dirLight.shadow.camera.left = -d;
  dirLight.shadow.camera.right = d;
  dirLight.shadow.camera.top = d;
  dirLight.shadow.camera.bottom = -d;

  scene.add(dirLight);
}

// ================= L√ìGICA DE INTERACCI√ìN T√ÅCTIL =================

function onPointerDown(event) {
  // Si ya estamos interactuando con el gizmo, ignorar este toque para selecci√≥n
  if (isInteractingWithGizmo) return;

  // Calcular coordenadas normalizadas del toque (-1 a +1)
  const rect = renderer.domElement.getBoundingClientRect();
  mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
  mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

  // Lanzar rayo desde la c√°mara
  raycaster.setFromCamera(mouse, camera);
  // Intersectar solo con nuestros objetos creados
  const intersects = raycaster.intersectObjects(objects, false);

  if (intersects.length > 0) {
    // Se toc√≥ un objeto
    selectObject(intersects[0].object);
  } else {
    // Se toc√≥ el fondo, deseleccionar si no es un toque multitouch (zoom/pan)
    if(event.isPrimary) selectObject(null);
  }
}

function selectObject(object) {
  // Restaurar el color de los objetos no seleccionados
  objects.forEach(obj => {
    if(obj.material.emissive) obj.material.emissive.setHex(0x000000);
  });

  if (object) {
    // Conectar el GIZMO al objeto seleccionado
    transformControl.attach(object);
    
    document.getElementById('sel-name').innerText = "Objeto Activo";
    document.getElementById('sel-name').style.color = "#ffffff";
    
    // Feedback visual: hacer el objeto seleccionado m√°s brillante
    if(object.material.emissive) object.material.emissive.setHex(0x555555);
    
  } else {
    // Desconectar el GIZMO (ocultarlo)
    transformControl.detach();
    document.getElementById('sel-name').innerText = "Ninguna";
    document.getElementById('sel-name').style.color = "#2b7fdb";
  }
}

// ================= ACCIONES DE LA BARRA DE HERRAMIENTAS =================

function spawnObject(type) {
  let geo;
  switch (type) {
    case 'box': geo = new THREE.BoxGeometry(1.2, 1.2, 1.2); break;
    case 'sphere': geo = new THREE.SphereGeometry(0.7, 32, 32); break;
    default: geo = new THREE.BoxGeometry(1, 1, 1);
  }

  // Material PBR de alta calidad
  const mat = new THREE.MeshStandardMaterial({
    color: Math.random() * 0xffffff,
    roughness: 0.4,
    metalness: 0.2,
    envMapIntensity: 0.5
  });

  const mesh = new THREE.Mesh(geo, mat);
  mesh.castShadow = true;
  mesh.receiveShadow = true;
  
  // Posici√≥n inicial aleatoria cerca del centro, sobre el suelo
  mesh.position.set(
    (Math.random() - 0.5) * 4,
    0.6 + Math.random() * 0.5,
    (Math.random() - 0.5) * 4
  );

  scene.add(mesh);
  objects.push(mesh);
  
  // Seleccionar autom√°ticamente el objeto nuevo
  selectObject(mesh);
}

function setTransformMode(mode) {
  // Cambiar el modo del GIZMO (esto cambia las flechas por anillos o cubos)
  transformControl.setMode(mode);
  
  // Actualizar la UI de los botones
  document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
  if(mode === 'translate') document.getElementById('btn-trans').classList.add('active');
  if(mode === 'rotate') document.getElementById('btn-rot').classList.add('active');
  if(mode === 'scale') document.getElementById('btn-scale').classList.add('active');
  
  let label = "";
  if(mode === 'translate') label = "MOVER (Ejes)";
  if(mode === 'rotate') label = "ROTAR (Ejes)";
  if(mode === 'scale') label = "ESCALAR (Ejes)";
  document.getElementById('mode-name').innerText = label;
}

function deleteSelected() {
  const obj = transformControl.object;
  if (!obj) return; // No hay nada seleccionado
  
  transformControl.detach(); // Quitar el gizmo primero
  scene.remove(obj); // Quitar de la escena
  
  // Quitar de nuestro array de objetos
  const index = objects.indexOf(obj);
  if (index > -1) objects.splice(index, 1);
  
  selectObject(null);
}

function onWindowResize() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

function animate() {
  requestAnimationFrame(animate);
  orbit.update(); // Necesario para la inercia suave de la c√°mara
  renderer.render(scene, camera);
}
</script>
</body>
</html>
